#!/usr/bin/env python
import json
import re
import sys

from mailur import conf, gmail, local, message

conf['USER'] = sys.argv[1]


def metadata_uids(con):
    uids = {}
    res = con.fetch('1:*', '(UID FLAGS)')
    for line in res:
        val = re.search(r'UID (\d+) FLAGS \(([^)]*)\)', line.decode())
        if not val:
            continue
        uid, flags = val.groups()
        name = [f for f in flags.split() if not f.startswith('\\')][0]
        if name not in uids or int(uids[name]) < int(uid):
            uids[name] = uid
    return uids

c = local.client('mlr/Sys')

settings_uid = metadata_uids(c)['settings']

res = c.fetch(settings_uid, 'BODY.PEEK[]')
body = res[0][1].decode()
if body.startswith('["settings"'):
    name, value = json.loads(body)
    local.data_settings(value)

settings_uid = local.metadata_uids()['settings']
c.select('mlr/Sys', readonly=False)
uids = c.search('not uid %s' % settings_uid)
c.store(uids, '+FLAGS.SILENT', '\\Deleted')
c.expunge()
local.update_metadata('1:*')
