#!/usr/bin/env python
import json
import re
import sys

from mailur import conf, gmail, local, message

conf['USER'] = sys.argv[1]

c = local.client()

metadata = (
    ('tags', lambda v: local.data_tags(v)),
    ('gmail/credentials', lambda v: gmail.data_credentials(*v))
)

for name, fn in metadata:
    res = c.getmetadata('INBOX', name)
    val = json.loads(res[0][1])
    fn(val)

mids = local.data_msgids.get()
c.select('INBOX')
links = c.search('from mailur@link')
if not links:
    print('--- No more links')
    sys.exit()

print('--- Processing %s links' % len(links))
res = c.fetch(links, '(UID BODY.PEEK[HEADER.FIELDS (References)])')
for num, i in enumerate(range(0, len(res), 2), 1):
    pattern = r'UID (\d+) FLAGS \(([^)]*)\)'
    uid = res[i][0].decode().split()[2]
    refs = re.sub('^References: ?', '', res[i][1].decode()).strip().split()
    refs = [r for r in refs if not r.endswith('@mailur.link>')]
    uids = sum((mids.get(message.normalize_msgid(i), []) for i in refs), [])
    if uids:
        local.link_threads(uids)
        print('--- Link #%s created' % num)
    else:
        print('--- Link #%s skipped, no real message-ids' % num)

if links:
    c.select('INBOX', readonly=False)
    c.store(links, '+FLAGS.SILENT', '\\Deleted')
    c.expunge()

